---
title: "The qgcomp package: g-computation on exposure quantiles"
author: "Alexander Keil"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{The qgcomp package: g-computation on exposure quantiles}
  %\VignetteEngine{knitr::knitr}
  \usepackage[utf8]{inputenc}
---

## Introduction
`qgcomp` is a package to implement g-computation for analyzing the effects of exposure
mixtures. Quantile g-computation yields estimates of the effect of increasing
all exposures by one quantile, simultaneously. This, it estimates a "mixture
effect" useful in the study of exposure mixtures such as air pollution, diet,
and water contamination.

The implementation in `qgcomp` is based on a generalization of weighted
quantile sums (WQS) regression, which estimates the expected change in an outcome
under a hypothetical intervention to increase all exposures in the mixture by
one quantile. In the case in which all exposures have linear, additive effects 
on the quantile scale (i.e. after transforming all exposures into categorical
variables defined by quantiles) `qgcomp` and WQS regression
are asymptotically equivalent when all variables have effects in
the same direction (the 'directional homogeneity' assumption of WQS). In moderate
samples when underlying assumptions are not met exactly, 
WQS will tend to yield more biased effect estimates due to the assumption
of directional homogeneity, and may also have lower precision due to the use
of sample splitting. In cases in which the assumptions
underlying WQS are met,`qgcomp` provides valid estimates of WQS 'weights',
which estimate the relative contribution of each exposure to the overall 
mixture effect. Thus, `qgcomp` will provide valid effect estimates of
the entire exposure mixture in general cases, while also allowing deviations
from linearity and additivity assumptions. 

Using terminology from methods developed for causal effect estimation, quantile 
g-computation estimates the parameters of a marginal structural model that 
characterizes the change in the expected potential outcome given a joint intervention
on all exposures, possibly conditional on confounders. Under the assumptions of
exchangeability, causal consistency, positivity, no interference, and correct
model specification, this model yields a causal effect for an intervention
on the mixture as a whole. While these assumptions may not be met exactly, they
provide a useful roadmap for how to interpret the results of a qgcomp fit, and
where efforts should be spent in terms of ensuring accurate model specification
and selection of exposures that are sufficient to control co-pollutant confounding.

## How to use the `qgcomp` package
Here we use a running example from the `metals` dataset from the from the package 
`qgcomp` to demonstrate some features of the package and method. 

Similar examples can be seen in the `gQWS` package help files, which implements
WQS regression.

```{r, echo=TRUE, results='markup', message=FALSE}
library(qgcomp)
library(knitr)
data("metals", package="qgcomp")
head(metals)
```


### Example 1: linear model

```{r, results='markup', fig.show='hold', fig.height=7, fig.width=10, cache=FALSE}
# we save the names of the mixture variables in the variable "Xnm"
Xnm <- c(
    'arsenic','barium','cadmium','calcium','chloride','chromium','copper',
    'iron','lead','magnesium','manganese','mercury','selenium','silver',
    'sodium','zinc'
)
covars = c('nitrate','nitrite','sulfate','ph', 'total_alkalinity','total_hardness')



# Example 1: linear model
# Run the model and save the results "qc.fit"
system.time(qc.fit <- qgcomp.noboot(y~.,dat=metals[,c(Xnm, 'y')], family=gaussian()))
#   user  system elapsed 
#  0.011   0.002   0.018 

# contrasting other methods with computational speed
# WQS regression
#system.time(wqs.fit <- gwqs(y~NULL,mix_name=Xnm, data=metals[,c(Xnm, 'y')], family="gaussian"))
#   user  system elapsed 
# 35.775   0.124  36.114 

# Bayesian kernel machine regression (note that the number of iterations here would 
#  need to be >5,000, at minimum, so this underestimates the run time by a factor
#  of 50+
#system.time(bkmr.fit <- kmbayes(y=metals$y, Z=metals[,Xnm], family="gaussian", iter=100))
#   user  system elapsed 
# 81.644   4.194  86.520 


#first note that qgcomp is very fast

# View results: scaled coefficients/weights and statistical inference about
# mixture effect
qc.fit



```
One advantage of quantile g-computation over other methods that estimate 
"mixture effects" (the effect of changing all exposures at once), is that it 
is very computationally efficient. Contrasting methods such as WQS (`gWQS` 
package) and Bayesian Kernel Machine regression (`bkmr` package), 
quantile g-computation can provide results many orders of magnitude faster.
For example, the example above ran 3000X faster for quantile g-computation
versus WQS regression, and we estimate the speedup would be several
hundred thousand times versus Bayesian kernel machine regression. 

Quantile g-computation yields fixed weights in the estimation procedure, similar
to WQS regression. However, note that the weights from `qgcomp.noboot` 
can be negative or positive. When all effects are linear and in the same 
direction ("directional homogeneity"), quantile g-computation is equivalent to 
weighted quantile sum regression in large samples.

The overall mixture effect from quatile g-computation (psi1) is interpreted as 
the effect on the outcome of increasing every exposure by one quantile, possibly
conditional on covariates. Given the overall exposure effect, the weights are
considered fixed and so


### Example 2: conditional odds ratio, marginal odds ratio in a logistic model

This example introduces the use of a binary outcome in `qgcomp` via the 
`qgcomp.noboot` function, which yields a conditional odds ratio or the
`qgcomp.boot`, which yields a marginal odds ratio or risk/prevalence ratio. These
will not equal each other when there are non-exposure covariates (e.g. 
confounders) included in the model because the odds ratio is not collapsible (both
are still valid). Marginal parameters will yield estimates of the population
average exposure effect, which is often of more interest due to better 
interpretability over conditional odds ratios. Further, odds ratios are not
generally of interest when risk ratios can be validly estimated, so `qgcomp.boot`
will estimate the risk ratio by default for binary data (set rr=FALSE to 
allow estimation of ORs when using `qgcomp.boot`).

```{r, results='markup', fig.show='hold', fig.height=7, fig.width=10, cache=FALSE}

qc.fit2 <- qgcomp.noboot(disease_state~., expnms=Xnm, 
          data = metals[,c(Xnm, 'disease_state')], family=binomial(), 
          q=4)
qcboot.fit2 <- qgcomp.boot(disease_state~., expnms=Xnm, 
          data = metals[,c(Xnm, 'disease_state')], family=binomial(), 
          q=4, B=10,# B should be 200-500+ in practice
          seed=125, rr=FALSE)
qcboot.fit2b <- qgcomp.boot(disease_state~., expnms=Xnm, 
          data = metals[,c(Xnm, 'disease_state')], family=binomial(), 
          q=4, B=10,# B should be 200-500+ in practice
          seed=125, rr=TRUE)


# Compare a qgcomp.noboot fit:
qc.fit2
# and a qgcomp.boot fit:
qcboot.fit2
# and a qgcomp.boot fit, where the risk/prevalence ratio is estimated, 
#  rather than the odds ratio:
qcboot.fit2b

```

### Example 3: adjusting for covariates, plotting estimates

In the following code we run a maternal age-adjusted linear model with 
`qgcomp` (`family = "gaussian"`). 

```{r, results='markup', fig.show='hold', fig.height=7, fig.width=10, cache=FALSE}

qc.fit3 <- qgcomp.noboot(y ~ mage35 + arsenic + barium + cadmium + calcium + chloride + 
                           chromium + copper + iron + lead + magnesium + manganese + 
                           mercury + selenium + silver + sodium + zinc,
                         expnms=Xnm,
                         metals, family=gaussian(), q=4)
plot(qc.fit3)
qcboot.fit3 <- qgcomp.boot(y ~ mage35 + arsenic + barium + cadmium + calcium + chloride + 
                           chromium + copper + iron + lead + magnesium + manganese + 
                           mercury + selenium + silver + sodium + zinc,
                         expnms=Xnm,
                         metals, family=gaussian(), q=4, B=10,# B should be 200-500+ in practice
                         seed=125)
plot(qcboot.fit3)

```

From the first plot we see weights from `qgcomp.noboot` function, which include both
positive and negative effect directions. Using `qgcomp.boot` also allows us to assess
linearity of the total exposure effect (the second plot). Similar output is available
for WQS (`gWQS` package), though WQS results will generally be less interpretable
when exposure effects are non-linear (see below how to do this with `qgcomp.boot`. 

The plot for the `qcboot.fit3` object (using g-computation with bootstrap variance) 
gives predictions at the joint intervention levels of exposure. It also displays
a smoothed (graphical) fit. Generally, we cannot overlay the data over this plot
since the regression line corresponds to a change in potentially many exposures
at once. Hence, it is useful to explore non-linearity by fitting models that
allow for non-linear effects.


### Example 4: non-linearity (and non-homogeneity)

Let's close with one more feature of `qgcomp` (and `qgcomp.boot`): handling non-linearity. 
Here is an example where we use a feature of the R language for fitting models
with interaction terms. We use `y~. + .^2` as the model formula, which fits a model
that allows for quadratic term for every predictor in the model.

Similar approaches could be used to include interaction terms between exposures, 
as well as between exposures and covariates. 


```{r, results='markup', fig.show='hold', fig.height=7, fig.width=10, cache=FALSE}

qcboot.fit4 <- qgcomp(y~. + .^2,
                         expnms=Xnm,
                         metals[,c(Xnm, 'y')], family=gaussian(), q=4, B=10, seed=125)
plot(qcboot.fit4)
```

Note that allowing for a non-linear effect of all exposures induces an apparent 
non-linear trend in the overall exposure effect. The smoothed regression line is 
still well within the confidence bands of the marginal linear model 
(by default, the overall effect of joint exposure is assumed linear, 
though this assumption can be relaxed via the 'degree' parameter in qgcomp.boot, 
as follows:

```{r, results='markup', fig.show='hold', fig.height=7, fig.width=10, cache=FALSE}

qcboot.fit5 <- qgcomp(y~. + .^2,
                         expnms=Xnm,
                         metals[,c(Xnm, 'y')], family=gaussian(), q=4, degree=2, B=10, seed=125)
plot(qcboot.fit5)
```

Ideally, the smooth fit will look very similar to the model prediction regression 
line.

## References
Alexander P. Keil, Jessie P. Buckley, Katie M. O’Brien, Kelly K. Ferguson, Shanshan Zhao,
Alexandra J. White. A quantile-based g-computation approach to addressing the effects of exposure mixtures. <arXiv:1902.04200> 

## Acknowledgements

The development of this package was supported by NIH Grant RO1ES02953101
